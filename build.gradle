// version = '0.1-SNAPSHOT'
// version = new ProjectVersion(0, 2)
ext {
  versionFile= file('version.properties')
}

task loadVersionProperties {
  version = readVersionProperties()
}

task printVersion {
  println version
}

task makeReleaseVersion(
    type: DefaultTask,
    group: 'versioning', 
    description: 'Makes project a release version.',
    dependsOn: [loadVersionProperties]) {
      // inputs.property('release', version.release)
      // outputs.file versionFile
      outputs.upToDateWhen {
        version.release == true
      }
      doLast {
        version.release = true
        ant.propertyfile(file: versionFile) {
          entry(key: 'release', type: 'string', operation: '=', value: 'true')
        }
      }
}

ProjectVersion readVersionProperties () {

  if(!project.versionFile.exists()) {
    throw new GradleException("Required version.properties file not found: $versionFile.canonicalPath")
  }

  Properties versionProperties = new Properties();
  versionFile.withInputStream { stream ->
    versionProperties.load(stream);
  }

  new ProjectVersion(versionProperties.major.toInteger(),
                     versionProperties.minor.toInteger(),
                     versionProperties.release.toBoolean())
}

class ProjectVersion {
  private Integer major;
  private Integer minor;
  private Boolean release;

  ProjectVersion(Integer major, Integer minor) {
    this.major = major;
    this.minor = minor;
  }

   ProjectVersion(Integer major, Integer minor, Boolean release) {
    this(major, minor)
    this.release = release
  }

  @Override 
  String toString() {
    return "$major.$minor${release ? "" : "-SNAPHOST"}"
  }
}